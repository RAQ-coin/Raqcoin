# This makefile will build a macOS ARM64 library
# Adapted from ubuntu x86 version for Apple Silicon

#==============================================================================
# macOS pathes
#==============================================================================
PATH_GNU_BIN=/usr/bin

#==============================================================================
# macOS binaries
#==============================================================================
CC=$(PATH_GNU_BIN)/clang
CXX=$(PATH_GNU_BIN)/clang++
RAN=$(PATH_GNU_BIN)/ranlib


#==============================================================================
# Build options for macOS ARM64
#==============================================================================
CFLAGS= -D MAC_OSX -D ARM64_VERSION -lpthread -fno-stack-protector
ARFLAGS=rs



#==============================================================================
# User root path
#==============================================================================
CSRC_DIR :=../../src/rainbow/core/
SSRC_DIR :=
INC_DIR :=-I ../../src/rainbow/core/  -I ../../include/ 
OUT_DIR := ./
BIN_DIR :=./
LIBPATH= -L/opt/homebrew/lib -L/usr/local/lib

OBJ:= 
OBJ += $(OUT_DIR)rb_core_parallel_matrix_op.o
OBJ += $(OUT_DIR)rb_core_rainbow.o
OBJ += $(OUT_DIR)rb_core_rainbow_keypair.o
OBJ += $(OUT_DIR)rb_core_rainbow_keypair_computation.o
OBJ += $(OUT_DIR)rb_core_rainbow_publicmap.o
OBJ += $(OUT_DIR)rb_core_aes256_ecb.o
OBJ += $(OUT_DIR)rb_core_blas_comm.o
OBJ += $(OUT_DIR)rb_core_blas_matrix.o
OBJ += $(OUT_DIR)rb_core_blas_matrix_ref.o
OBJ += $(OUT_DIR)rb_core_common_functions.o
OBJ += $(OUT_DIR)rb_core_fortuna.o
OBJ += $(OUT_DIR)rb_core_random.o
OBJ += $(OUT_DIR)rb_core_rijndael.o
OBJ += $(OUT_DIR)rb_core_rng.o
OBJ += $(OUT_DIR)rb_core_sign.o
OBJ += $(OUT_DIR)rb_core_sha256.o
OBJ += $(OUT_DIR)rb_core_sha256_pqc.o
OBJ += $(OUT_DIR)rb_core_sha512.o
OBJ += $(OUT_DIR)rb_core_utils.o
OBJ += $(OUT_DIR)rb_core_utils_hash.o
OBJ += $(OUT_DIR)rb_core_utils_prng.o
OBJ += $(OUT_DIR)rb_core_rainbow-genkey.o
OBJ += $(OUT_DIR)rb_core_rainbow-sign.o
OBJ += $(OUT_DIR)rb_core_rainbow-verify.o
# Note: Removed rb_core_blas_comm_sse.o as it's x86-specific SSE code



OUTPUT_TARGET=$(BIN_DIR)librainbowpro_unix.a 



.PHONY:
$(OUT_DIR)%.o: $(CSRC_DIR)%.c 
	$(CC) -c -march=armv8-a+crypto -O3 -lm $(CFLAGS) $(INC_DIR) -o $@ $<
	

all : $(OUTPUT_TARGET) 

$(OUTPUT_TARGET) : $(OBJ) 
	$(AR)  $(ARFLAGS) $@ $^
	$(RAN) $@
	rm *.o
clean:
	rm -f $(OUTPUT_TARGET)
	rm -f *.o
